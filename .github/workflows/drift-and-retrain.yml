name: Drift Check and Conditional Retrain

on:
  workflow_dispatch:
  schedule:
    - cron: "0 10 * * *"   # daily at 10:00 UTC

jobs:
  drift_retrain:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare reference + current datasets (sample)
        run: |
          mkdir -p artifacts/monitoring
          python src/monitoring/make_current_from_reference.py \
            --infile data/sample/creditcard_sample.csv \
            --outfile data/sample/creditcard_current.csv \
            --amount_multiplier 50

      - name: Run drift check
        run: |
          python src/monitoring/drift_check.py \
            --reference data/sample/creditcard_sample.csv \
            --current data/sample/creditcard_current.csv \
            --out artifacts/monitoring/drift_report.json

      - name: Show drift report
        run: |
          cat artifacts/monitoring/drift_report.json

      - name: Retrain if drift trigger is true
        id: retrain
        run: |
          python -c "import json; r=json.load(open('artifacts/monitoring/drift_report.json')); print('trigger_retrain=', r.get('trigger_retrain'))"
          python - << 'PY'
          import json, sys, os, subprocess
          r=json.load(open("artifacts/monitoring/drift_report.json"))
          if not r.get("trigger_retrain"):
              print("No retraining needed.")
              sys.exit(0)
          os.makedirs("artifacts/model", exist_ok=True)
          subprocess.check_call([
              "python","src/training/train_model.py",
              "--data","data/sample/creditcard_sample.csv",
              "--outdir","artifacts/model",
              "--threshold","0.5"
          ])
          PY

      - name: Upload reports + model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: drift-and-model-artifacts
          path: |
            artifacts/monitoring/drift_report.json
            artifacts/model/model.joblib
            artifacts/model/metadata.json
